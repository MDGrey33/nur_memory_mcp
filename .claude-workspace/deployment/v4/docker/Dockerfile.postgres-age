# PostgreSQL with Apache AGE and pgvector for MCP Memory V4
FROM postgres:16-alpine

LABEL maintainer="MCP Memory DevOps"
LABEL description="PostgreSQL 16 with Apache AGE and pgvector for MCP Memory V4"

# Build arguments
ARG AGE_VERSION=1.5.0
ARG PGVECTOR_VERSION=0.7.4

# Install build dependencies (fixed package names for Alpine)
RUN apk add --no-cache --virtual .build-deps \
    git \
    build-base \
    clang \
    llvm \
    bison \
    flex \
    readline-dev \
    zlib-dev \
    perl

# Install pgvector from source (simpler, do first)
WORKDIR /tmp
RUN git clone --depth 1 --branch v${PGVECTOR_VERSION} https://github.com/pgvector/pgvector.git \
    && cd pgvector \
    && make PG_CONFIG=/usr/local/bin/pg_config install \
    && cd .. \
    && rm -rf pgvector

# Install Apache AGE from source
RUN git clone --depth 1 --branch PG16/v${AGE_VERSION} https://github.com/apache/age.git \
    && cd age \
    && make PG_CONFIG=/usr/local/bin/pg_config install \
    && cd .. \
    && rm -rf age

# Clean up build dependencies
RUN apk del .build-deps \
    && rm -rf /tmp/*

# Runtime dependencies
RUN apk add --no-cache libstdc++

# AGE configuration: preload library
RUN echo "shared_preload_libraries = 'age'" >> /usr/local/share/postgresql/postgresql.conf.sample

# Create initialization script for extensions
RUN mkdir -p /docker-entrypoint-initdb.d
RUN echo "CREATE EXTENSION IF NOT EXISTS vector;" > /docker-entrypoint-initdb.d/00-extensions.sql \
    && echo "CREATE EXTENSION IF NOT EXISTS age;" >> /docker-entrypoint-initdb.d/00-extensions.sql \
    && echo "LOAD 'age';" >> /docker-entrypoint-initdb.d/00-extensions.sql \
    && echo "SET search_path = ag_catalog, \"\\\$user\", public;" >> /docker-entrypoint-initdb.d/00-extensions.sql

WORKDIR /
EXPOSE 5432
VOLUME /var/lib/postgresql/data

HEALTHCHECK --interval=10s --timeout=5s --retries=5 --start-period=45s \
    CMD pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-postgres} || exit 1
