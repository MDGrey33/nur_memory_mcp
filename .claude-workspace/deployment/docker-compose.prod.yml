version: '3.8'

services:
  # ChromaDB - Vector database for persistent storage
  chroma:
    image: chromadb/chroma:latest
    container_name: chroma-prod
    user: "1000:1000"
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Security hardening
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true

    # Volumes
    volumes:
      - chroma_data:/chroma/chroma
      - ./secrets/certs:/secrets/certs:ro

    # Temporary filesystems
    tmpfs:
      - /tmp:noexec,nosuid,size=100M

    # Environment variables
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      # TLS Configuration (uncomment when certificates are ready)
      # - CHROMA_SERVER_SSL_ENABLED=true
      # - CHROMA_SERVER_SSL_CERTFILE=/secrets/certs/chroma-cert.pem
      # - CHROMA_SERVER_SSL_KEYFILE=/secrets/certs/chroma-key.pem
      # Authentication (uncomment when configured)
      # - CHROMA_SERVER_AUTHN_ENABLED=true
      # - CHROMA_SERVER_AUTHN_CREDENTIALS_FILE=/run/secrets/chroma_credentials

    # Secrets (uncomment when using authentication)
    # secrets:
    #   - chroma_credentials

    # Health check
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=chroma,environment=production"

    # Network
    networks:
      - mcp-memory-network

    # DO NOT expose ports in production - internal access only
    # For debugging, use: docker exec -it chroma-prod curl http://localhost:8000/api/v1/heartbeat
    # ports:
    #   - "127.0.0.1:8000:8000"  # Bind to localhost only if needed

  # chroma-mcp - MCP gateway to ChromaDB
  chroma-mcp:
    image: ghcr.io/chroma-core/chroma-mcp:latest
    container_name: chroma-mcp-prod
    user: "1000:1000"
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Security hardening
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    cap_drop:
      - ALL

    # Dependencies
    depends_on:
      chroma:
        condition: service_healthy

    # Environment variables
    environment:
      - CHROMA_CLIENT_TYPE=http
      - CHROMA_HTTP_HOST=chroma
      - CHROMA_HTTP_PORT=8000
      # Update to https when TLS is enabled
      # - CHROMA_HTTP_PROTOCOL=https

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=chroma-mcp,environment=production"

    # Network
    networks:
      - mcp-memory-network

  # agent-app - LLM agent application
  agent-app:
    build:
      context: ../implementation/agent-app
      dockerfile: Dockerfile
    image: mcp-memory-agent:${VERSION:-latest}
    container_name: agent-app-prod
    user: "1000:1000"
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Security hardening
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    cap_drop:
      - ALL
    read_only: true

    # Temporary filesystems
    tmpfs:
      - /tmp/app:noexec,nosuid,size=50M

    # Dependencies
    depends_on:
      chroma-mcp:
        condition: service_started
      chroma:
        condition: service_healthy

    # Environment variables from .env.production
    env_file:
      - .env.production

    # Secrets (uncomment when using authentication)
    # secrets:
    #   - api_key

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=agent-app,environment=production"

    # Network
    networks:
      - mcp-memory-network

    # Uncomment to expose API if you add HTTP endpoints
    # ports:
    #   - "127.0.0.1:8080:8080"

# Docker volumes for persistence
volumes:
  chroma_data:
    driver: local
    name: mcp_memory_chroma_data_prod
    # Optional: specify backup location
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /data/mcp-memory/chroma

# Docker network for inter-service communication
networks:
  mcp-memory-network:
    driver: bridge
    name: mcp-memory-prod-network

# Docker secrets (uncomment when implementing authentication)
# secrets:
#   api_key:
#     file: ./secrets/api_key.txt
#   chroma_credentials:
#     file: ./secrets/chroma_credentials.txt
