# V6.1 Cleanup Plan: Remove Legacy Storage/Retrieval Code

**Version:** 6.1.0
**Date:** 2026-01-01
**Status:** IMPLEMENTED
**Prerequisite:** V6.0.0 (tool deletion complete)

---

## Objective

V6.0 removed 17 legacy tools from server.py but left behind supporting infrastructure that is now unreachable from the 4 V6 tools. This plan identifies and removes that dead code.

**Estimated reduction:** ~500 additional lines of code

---

## Issue Summary

| Component | Issue | Action |
|-----------|-------|--------|
| `storage/collections.py` | Legacy collection functions still defined | DELETE |
| `storage/__init__.py` | Exports legacy functions | UPDATE |
| `services/retrieval_service.py` | Legacy `hybrid_search()` + imports | DELETE |
| `worker/event_worker.py` | Fallback reads from legacy collections | REMOVE or DOCUMENT |
| Unit tests | Test legacy functions keeping them alive | DELETE |
| Documentation | Stale V3/event tool references | UPDATE |

---

## Phase 1: Confirm Dead Code (Analysis)

### 1.1 Legacy Collection Functions - Confirm Unused

Run grep to confirm no V6 code paths use these:

```bash
# Should return only: imports, definitions, tests, and worker fallbacks
grep -rn "get_memory_collection\|get_history_collection\|get_artifacts_collection\|get_artifact_chunks_collection" src/ tests/ --include="*.py"
```

**Expected result:** Only found in:
- `storage/collections.py` (definitions)
- `storage/__init__.py` (exports)
- `services/retrieval_service.py` (legacy hybrid_search)
- `worker/event_worker.py` (fallback paths)
- `tests/unit/storage/test_collections.py` (legacy tests)

### 1.2 Legacy RetrievalService Methods - Confirm Unused

```bash
# Check callers of legacy hybrid_search
grep -rn "\.hybrid_search\(" src/ --include="*.py" | grep -v hybrid_search_v5
```

**Expected result:** Only self-calls within retrieval_service.py, no external callers

---

## Phase 2: Delete Legacy Storage Code

### 2.1 Delete from `src/storage/collections.py`

**DELETE these functions:**
- `get_memory_collection()` (lines 21-41)
- `get_history_collection()` (lines 43-63)
- `get_artifacts_collection()` (lines 65-85)
- `get_artifact_chunks_collection()` (lines 87-107)
- `get_chunks_by_artifact()` (lines 109-154)
- `get_artifact_by_source()` (lines 156-196)
- `delete_artifact_cascade()` (lines 198-251)

**KEEP these V6 functions:**
- `get_content_collection()`
- `get_chunks_collection()`
- `get_content_by_id()`
- `get_v5_chunks_by_content()`
- `delete_v5_content_cascade()`

### 2.2 Update `src/storage/__init__.py`

Remove legacy exports:
```python
# DELETE these exports
"get_memory_collection",
"get_history_collection",
"get_artifacts_collection",
"get_artifact_chunks_collection",
"get_chunks_by_artifact",
"get_artifact_by_source",
"delete_artifact_cascade",
```

---

## Phase 3: Delete Legacy Retrieval Code

### 3.1 Delete from `src/services/retrieval_service.py`

**DELETE these imports:**
```python
from storage.collections import (
    get_memory_collection,
    get_artifacts_collection,
    get_artifact_chunks_collection,
    get_chunks_by_artifact,
    ...
)
```

**DELETE these methods:**
- `_search_collection()` (if only used by legacy hybrid_search)
- `hybrid_search()` (the legacy V3/V4 version)
- `hybrid_search_v4()` (if hybrid_search_v5 supersedes it)

**KEEP:**
- `hybrid_search_v5()` (used by recall())
- `_expand_from_events_sql()` (used by V5)
- RRF merging helpers (used by V5)

### 3.2 Audit `hybrid_search_v4()` Usage

```bash
grep -rn "hybrid_search_v4" src/ --include="*.py"
```

If only called from deleted legacy `hybrid_search()` tool, delete it.
If called from V5/V6 paths, keep it.

---

## Phase 4: Clean Worker Fallbacks

### 4.1 Decision: Legacy Data Compatibility

**Option A: Clean break (no legacy data support)**
- DELETE fallback paths in `event_worker.py`
- DELETE imports of legacy collection functions

**Option B: Maintain migration path**
- KEEP fallback paths
- ADD documentation explaining compat mode
- ADD deprecation warning logs

### 4.2 If Option A (Clean Break)

In `src/worker/event_worker.py`:

**DELETE lines ~508-520:**
```python
# Fallback to legacy artifacts collection
collection = get_artifacts_collection(client)
```

**DELETE lines ~542-550:**
```python
# Fallback to legacy get_chunks_by_artifact
chunks = get_chunks_by_artifact(client, artifact_id)
```

---

## Phase 5: Delete Legacy Tests

### 5.1 Delete Legacy Unit Tests

In `tests/unit/storage/test_collections.py`:

**DELETE these tests:**
- `test_get_memory_collection`
- `test_get_history_collection`
- `test_get_artifacts_collection`
- `test_get_artifact_chunks_collection`
- `test_get_chunks_by_artifact_success`
- `test_get_chunks_by_artifact_not_found`
- `test_get_chunks_by_artifact_error`
- `test_get_artifact_by_source_found`
- `test_get_artifact_by_source_not_found`
- `test_get_artifact_by_source_error`
- `test_delete_artifact_cascade_unchunked`
- `test_delete_artifact_cascade_with_chunks`
- `test_delete_artifact_cascade_artifact_error`
- `test_delete_artifact_cascade_chunks_error`

### 5.2 Delete Legacy Retrieval Tests

In `tests/unit/services/test_retrieval_service.py`:

**DELETE tests for legacy hybrid_search:**
- `test_hybrid_search_without_memory`
- `test_hybrid_search_with_memory`
- `test_hybrid_search_with_filters`
- `test_hybrid_search_respects_limit`
- `test_hybrid_search_empty_results`
- `test_search_collection_memory`
- `test_search_collection_artifacts`
- `test_search_collection_chunks`
- `test_search_collection_with_filters`

**KEEP tests for:**
- RRF merging (still used)
- `expand_neighbors` (still used)
- Any hybrid_search_v5 tests

---

## Phase 6: Update Documentation

### 6.1 Update `src/tools/event_tools.py`

Update docstring to remove claims about exposing tools:
```python
"""
V3 Event Tools - Internal Functions

These functions are used internally by the V6 recall() tool
for semantic event search. They are NOT exposed as MCP tools.
"""
```

### 6.2 Archive or Delete Stale Docs

- `.claude-workspace/implementation/mcp-server/V3_IMPLEMENTATION_SUMMARY.md` - DELETE or move to `/archive`

---

## Verification Checklist

After cleanup, verify:

```bash
# 1. Only 4 tools exposed
python -c "import asyncio; from server import mcp; print(asyncio.run(mcp.list_tools()))"
# Expected: [remember, recall, forget, status]

# 2. No legacy collection references in server.py
grep -n "get_memory_collection\|get_artifacts_collection" src/server.py
# Expected: no matches

# 3. Tests pass
PYTHONPATH=src pytest tests/ ../../tests/v5/ -v

# 4. No unused imports
pip install autoflake
autoflake --check src/server.py src/storage/collections.py src/services/retrieval_service.py
```

---

## Summary of Deletions

| File | Lines Deleted (est.) |
|------|---------------------|
| `storage/collections.py` | ~230 |
| `storage/__init__.py` | ~15 |
| `services/retrieval_service.py` | ~200 |
| `worker/event_worker.py` | ~50 (if Option A) |
| `test_collections.py` | ~150 |
| `test_retrieval_service.py` | ~100 |
| Stale docs | ~100 |
| **Total** | **~850 lines** |

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| Break existing deployments with legacy data | Option B: Keep fallback paths with deprecation |
| Tests fail after deletion | Run tests after each phase |
| Worker can't process old jobs | Drain job queue before deploying V6.1 |

---

## Rollback

Git history preserves everything:
```bash
git checkout HEAD~1 -- src/storage/collections.py src/services/retrieval_service.py
```
