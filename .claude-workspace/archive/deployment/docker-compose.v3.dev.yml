version: '3.8'

# MCP Memory Server V3 - Development Overrides
# Usage: docker-compose -f docker-compose.v3.yml -f docker-compose.v3.dev.yml up

services:
  chroma:
    environment:
      - LOG_CONFIG=debug
    # Port already exposed in base config

  postgres:
    # Port already exposed in base config
    environment:
      - POSTGRES_PASSWORD=dev_password_change_me
    command:
      - "postgres"
      - "-c"
      - "log_statement=all"
      - "-c"
      - "log_duration=on"
      - "-c"
      - "log_min_duration_statement=0"

  mcp-server:
    build:
      context: ../implementation/mcp-server
      dockerfile: ../../deployment/Dockerfile
      target: development
    volumes:
      # Hot reload for development
      - ../implementation/mcp-server/src:/app/src:ro
      - ../implementation/mcp-server/prompts:/app/prompts:ro
    environment:
      - LOG_LEVEL=DEBUG
      - PYTHONUNBUFFERED=1
      - OPENAI_EVENT_MODEL=gpt-4o-mini  # Cheaper model for dev
    ports:
      - "3000:3000"
      - "5678:5678"  # Debug port for debugpy/pdb
    command: >
      sh -c "pip install debugpy watchdog &&
             python -m debugpy --listen 0.0.0.0:5678 src/server.py"

  event-worker:
    build:
      context: ../implementation/mcp-server
      dockerfile: ../../deployment/Dockerfile
      target: development
    volumes:
      # Hot reload for development
      - ../implementation/mcp-server/src:/app/src:ro
      - ../implementation/mcp-server/prompts:/app/prompts:ro
    environment:
      - LOG_LEVEL=DEBUG
      - PYTHONUNBUFFERED=1
      - POLL_INTERVAL_MS=2000  # Slower polling in dev
      - OPENAI_EVENT_MODEL=gpt-4o-mini  # Cheaper model for dev
    ports:
      - "5679:5679"  # Debug port for worker
    command: >
      sh -c "pip install debugpy watchdog &&
             python -m debugpy --listen 0.0.0.0:5679 -m src.worker"

  # pgAdmin for database management (development only)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: mcp-pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@mcp.local
      - PGADMIN_DEFAULT_PASSWORD=admin
      - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - mcp-network
    depends_on:
      - postgres

volumes:
  pgadmin_data:
    driver: local
    name: mcp_memory_v3_pgadmin_data
